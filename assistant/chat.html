<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Caron’s Assistant</title>
  <style>
    :root { --brand: #05ABC3; }

    * { box-sizing: border-box; }
    body{
      font-family: Arial, system-ui, "Segoe UI";
      display:flex; justify-content:center;
      margin:0; padding:24px; background:#f7f9fb;
    }
    #chatbox{
      width:400px; max-width:100%;
      background:#fff; border:1px solid #e6eef2;
      border-radius:12px; box-shadow:0 8px 30px rgba(0,0,0,.06);
      overflow:hidden;
    }
    #header{ background:var(--brand); color:#fff; font-weight:700; padding:12px 14px; }
    #messages{ height:360px; overflow-y:auto; padding:12px; background:#fff; }
    .message{ margin:8px 0; line-height:1.35; }
    .user b{ color:#1b67ff; }
    .bot  b{ color:#2b8a3e; }
    #entry{ display:flex; gap:8px; border-top:1px solid #e6eef2; padding:10px; background:#fafcfd; }
    input{ flex:1; padding:10px; border:1px solid #dbe7ec; border-radius:8px; }
    button{
      min-width:88px; padding:10px 12px; border:0; border-radius:8px;
      background:var(--brand); color:#fff; font-weight:600; cursor:pointer;
    }
    button:disabled{ opacity:.6; cursor:not-allowed; }
  </style>
</head>
<body>
  <div id="chatbox">
    <div id="header">Caron’s Assistant</div>
    <div id="messages"></div>
    <div id="entry">
      <input type="text" id="userInput" placeholder="Type your message..." />
      <button id="sendBtn">Send</button>
    </div>
  </div>

  <script>
    // ---- Embed controls (brand + hide header + custom bot name)
    const params = new URLSearchParams(location.search);
    if (params.get('brandColor')) {
      document.documentElement.style.setProperty('--brand', params.get('brandColor'));
    }
    const BOT_NAME = params.get('botName') || "Caron’s Assistant";
    const hideHeader = params.get('hideHeader') === '1';
    if (hideHeader) {
      const hdr = document.getElementById('header');
      if (hdr) hdr.style.display = 'none';
      const msgs = document.getElementById('messages');
      if (msgs) msgs.style.height = '420px';
    }
    // -----------------------------------------

    // chat.html & voice.html
    const API_BASE = `${window.location.protocol}//${window.location.hostname}:3000`;
    const API_URL  = `${API_BASE}/chat`;
    // const API_URL = "http://localhost:3000/chat";
    const messagesDiv = document.getElementById("messages");
    const input = document.getElementById("userInput");
    const sendBtn = document.getElementById("sendBtn");

    function append(role, text) {
      const who = role === "user" ? "<b>You:</b>" : `<b>${BOT_NAME}:</b>`;
      messagesDiv.insertAdjacentHTML(
        "beforeend",
        `<div class="message ${role}">${who} ${escapeHtml(text)}</div>`
      );
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    function escapeHtml(s){
      return s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }

    async function sendMessage(){
      const message = input.value.trim();
      if(!message) return;

      append("user", message);
      input.value = "";
      sendBtn.disabled = true;

      try{
        const r = await fetch(API_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ message })
        });
        const data = await r.json();
        append("bot", data.reply || "…");
      }catch(e){
        append("bot", "Sorry, I couldn't reach the server.");
        console.error(e);
      }finally{
        sendBtn.disabled = false;
        input.focus();
      }
    }

    // Initial greeting on load
    async function loadGreeting(){
      try{
        const r = await fetch(API_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({}) // no message -> server returns greeting
        });
        const data = await r.json();
        append("bot", data.reply || "Hi! How can I help?");
      }catch(e){
        console.error(e);
        append("bot", "Hi! How can I help?");
      }
    }

    sendBtn.addEventListener("click", sendMessage);
    input.addEventListener("keydown", e => { if(e.key === "Enter") sendMessage(); });

    loadGreeting();
  </script>
</body>
</html>
